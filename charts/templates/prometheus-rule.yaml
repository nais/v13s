{{- if contains "nav" .Values.fasit.tenant.name }}
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{ .Release.Name }}-namespace-workload-vulnerability-alerts
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/name: {{ .Chart.Name }}
spec:
  groups:
    - name: namespace-workload-vulnerability-recording
      rules:

        - record: namespace:workload:vulnerabilities:critical:max3h
          expr: max by (workload_cluster, workload_namespace, workload_name, workload_type) (
            max_over_time(
            v13s_workload_vulnerabilities{
            severity="CRITICAL",
            workload_namespace="nais-system"
            }[3h]
            )
            )

        - record: namespace:workload:vulnerabilities:critical:recent_samples
          expr: max by (workload_cluster, workload_namespace, workload_name, workload_type) (
            count_over_time(
            v13s_workload_vulnerabilities{
            workload_namespace="nais-system"
            }[15m]
            ) > 0
            )

        - record: namespace:workload:vulnerabilities:critical:current
          expr: max by (workload_cluster, workload_namespace, workload_name, workload_type) (
            v13s_workload_vulnerabilities{
            severity="CRITICAL",
            workload_namespace="nais-system"
            }
            )
            or
            max by (workload_cluster, workload_namespace, workload_name, workload_type) (
            0 * v13s_workload_vulnerabilities{workload_namespace="nais-system"}
            )

    - name: namespace-workload-vulnerability-alerts
      rules:
        - alert: "workload critical vulnerabilities"
          expr: (namespace:workload:vulnerabilities:critical:max3h > 0)
            and (
            (namespace:workload:vulnerabilities:critical:current > 0)
            or on(workload_cluster, workload_namespace, workload_name, workload_type)
            ((namespace:workload:vulnerabilities:critical:recent_samples or vector(0)) == 0)
            )
          for: 10m
          labels:
            namespace: nais-system
            severity: warning
            channel: nais-alerts-info
            alert_type: custom
            repeat_interval: 1d
          annotations:
            summary: |
              {{ ":rotating_light: CRITICAL vulnerabilities in workload `{{ $labels.workload_name }}` (namespace `{{ $labels.workload_namespace }}`)" }}
            description: |
              {{ "Workload `{{ $labels.workload_name }}` in namespace `{{ $labels.workload_namespace }}` has {{ $value }} critical vulnerabilities." }}
              https://salsa.{{ .Values.fasit.tenant.name }}.cloud.nais.io/projects?searchText=nais-io
            consequence: Potential security risk; workload may be exploitable
            action: |
              Check vulnerabilities in Salsa. Consider patching or redeploying the affected workload.
{{- end }}
